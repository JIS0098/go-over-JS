<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="main.css" />
</head>

<body style="background-color: #f4f4f4">
  <nav class="nav">
    <a class="nav-link active" aria-current="page" href="#">집꾸미기</a>
    <a class="nav-link" href="#">Home</a>
    <a class="nav-link" href="#">스토어</a>
    <a class="nav-link" href="#">시공견적</a>
  </nav>

  <div class="container">
    <input class="search" type="text" placeholder="검색어 입력" />
  </div>

  <div id="container">
    <div class="row product-list"></div>
  </div>

  <div class="container" style="background-color: lightgrey; padding: 20px; margin-top: 20px">
    <h4>장바구니</h4>
    <div class="row cart">
      <p class="cart-text">여기로 드래그</p>
    </div>


    <script>
      let 눌렀던거;
      $(".nav a").on("click", (e) => {
        $(e.target).css("color", "white");
        $(눌렀던거).css("color", "gray");
        눌렀던거 = e.target;
      });

      let products = []
      let cart = []

      $.get("store.json").done((data) => {
        products = data.products;

        //불러온 상품api로 카드만들기
        products.forEach((a) => {
          $('.product-list').append(
            `<div class="col-md-3">
            <div class="item" draggable="true" data-id="${a.id}">
            <img src="${a.photo}"/>
            <h4>${a.title}</h4>
            <p>${a.brand}</p>
            <p>가격 : ${a.price}</p>
            <button class="add" data-id="${a.id}">담기</button>
            </div>
          </div>`
          )
        });

        // 담기버튼 관련 기능

        // 카드에 담기버튼을 누른 제품의 아이디와 서버에서 받아온 제품의 아이디를 비교
        // 카트에 제품이 있으면 제품html의 카운터만 ++ 
        // 없으면 html그려주기 
        $('.add').on('click', (e) => {
          let productId = e.target.dataset.id;
          let 제품순서 = cart.findIndex((a) => { return a.id == productId });

          if (제품순서 == -1) {
            let 현재상품 = products.find((a) => { return a.id == productId });
            현재상품.count = 1;
            cart.push(현재상품);
          } else {
            cart[제품순서].count++;
          }
          console.log(cart);
          $('.cart').html('')

          cart.forEach((a) => {
            $('.cart').append(
              `<div class="col-md-3" >
            <div class="cart-item" draggable="true" data-id="${a.id}">
            <img src="${a.photo}"/>
            <h4>${a.title}</h4>
            <p>${a.brand}</p>
            <p>가격 : ${a.price}</p>
            <input class=num type="text" value='${a.count}'>
            </div>
          </div>`
            )
          })
        })

        // 제품 드래그 관련 기능
        // 먼저 카트배열에 드래그를 시작한 제품객체와 같은 제품이 있다면 갯수만올리고 
        // 없다면 카드배열에 푸쉬하고 html을 그린다.
        $('.item').on('dragstart', (e) => {
          e.originalEvent.dataTransfer.setData('id', e.currentTarget.dataset.id);
        })

        $('.cart').on('dragover', (e) => {
          e.preventDefault()
        })

        $('.cart').on('drop', (e) => {
          $('.cart').html('')
          let productId = e.originalEvent.dataTransfer.getData('id');
          $('.add').eq(productId).click();
         
        })



        //검색기능
        $(".search").on('input', () => {
          var 검색어 = $('.search').val();
          $('.product-list').html('');

          var arr = productList.filter((product) => {
            return product.title.includes(검색어) || product.brand.includes(검색어)
          })

          arr.forEach((product) => {
            $('.product-list').append(
              `<div class="col-md-3">
            <div class="item" draggable="true" data-id="${product.id}">
            <img src="${product.photo}"/>
            <h4>${product.title}</h4>
            <p>${product.brand}</p>
            <p>가격 : ${product.price}</p>
            <button class="add" data-id="${product.id}">담기</button>
            </div>
          </div>`
            )
          });

          //검색어 포함한 html 배경색 넣기
          $('.product-list h4').each((i, h4) => {
            var title = h4.innerHTML
            title = title.replace(검색어, `<span style="background : yellow">${검색어}</span>`)
            h4.innerHTML = title
          })

          //검색기능 후 드래그
          $('.item').on('dragstart', (e) => {
            e.originalEvent.dataTransfer.setData('product', e.currentTarget.dataset.id);
          })
          $('.cart').on('drop', (e) => {
            var data = e.originalEvent.dataTransfer.getData('product')
            let cartProduct = productList.filter((product) => {
              return product.id == data
            })
          })
        })
      })
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"></script>
</body>

</html>
<!-- 
// 담기부터 제대로 다시하기 
        // 카드 배열을 만들고 아이디와 수량을 체크해 넣는다. 

        // let count=1
        // let arr =[]
        // $('.item').on('dragstart', (e) => {
        //   e.originalEvent.dataTransfer.setData('product', e.currentTarget.dataset.id);
        // })
        // $('.cart').on('drop', (e) => {
        //   $(".cart-text").html('')
        //   var data = e.originalEvent.dataTransfer.getData('product')
        //   let cartProduct = productList.filter((product) => {
        //     return product.id == data
        //   })

   
        //   $('.cart').append(
        //     `<div class="col-md-3" >
        //     <div class="cart-item" draggable="true" data-id="${cartProduct[0].id}">
        //     <img src="${cartProduct[0].photo}"/>
        //     <h4>${cartProduct[0].title}</h4>
        //     <p>${cartProduct[0].brand}</p>
        //     <p>가격 : ${cartProduct[0].price}</p>
        //     <input class=num type="text" value=${count}>
        //     </div>
        //   </div>`
        //   ) 

        // })
        // $('.cart').on('dragover', (e) => {
        //   e.preventDefault()
        // }) -->